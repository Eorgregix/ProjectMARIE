<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by TEMPLATED
http://templated.co
Released for free under the Creative Commons Attribution License

Name       : Red &amp; Black
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20120513

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Gestionnaire de compétences</title>
<link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700" rel="stylesheet">
<link href="style.css" rel="stylesheet" type="text/css" media="screen" />

</head>
<body>

<div id="wrapper">
	<div id="header-wrapper">
		<div id="header">
        	<img src="./img-head.jpg" alt="" width="1000" height="329" />
			<div id="menu">
				<ul>
					<li class="current_page_item"><a href="./index.html">Classes</a></li>
					<li ><a href="./backoffice.html">Compétences</a></li>
					<li ><a href="./backofficeClasse.html">élèves</a></li>
				</ul>
			</div>
		</div>
	</div>
	<!-- end #header -->
	<div id="page">
		<div id="page-bgtop">
			<div id="page-bgbtm">
				<div id="content">
					<div class="post">
						<h2 class="title"><a href="#">Charger une classe</a></h2>
						<div class="entry">
							<input type="file" id="file-input"/>
							<pre id="file-content" style="display:none"></pre>
						</div>
					</div>
					<div style="clear: both;">&nbsp;</div>
				</div>
				<div id="content">
					<div class="post">
						<h2 class="title"><a id='createClass' href="#">Créer une classe</a></h2>
						<div class="entry">
							<button id="butt"  onclick="createClasse()">Créer</button>
							<table><tr><td>
								<text id="classeText" style="display:none">élèves      :</text></td><td><input type="file" id="file-inputClasse" style="display:none"/></td></tr>
								<pre id="file-contentClasse" style="display:none"></pre>
								<tr><td><text id="skillText" style="display:none">Compétences :</text></td><td><input type="file" id="file-inputSkill" style="display:none"/></td></tr>
								<pre id="file-contentSkill" style="display:none"></pre>
							</table>
						</div>
					</div>
					<div style="clear: both;">&nbsp;</div>
				</div>
				<div id="content">
					<div class="post">
						<div class="entry" id="skills">
						</div>
					</div>
					<div style="clear: both;">&nbsp;</div>
				</div>
				<!-- end #content -->

				<!-- end #sidebar -->
				<div style="clear: both;">&nbsp;</div>
			</div>
		</div>
	</div>
	<!-- end #page -->
</div>
<!-- end #footer -->

<script>
  function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    displayContents(contents);
  };
  reader.readAsText(file);
}

function readSingleFileClasse(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    displayContentsClasse(contents);
  };
  reader.readAsText(file);
}

function readSingleFileSkill(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    displayContentsSkill(contents);
  };
  reader.readAsText(file);
}

function displayContents(contents) {
  var element = document.getElementById('file-content');
  element.innerHTML = contents;
  general = JSON.parse(contents);
	//document.getElementById('file-inputClasse').files[0].name = general.studentFile;
	//document.getElementById('file-inputSkill').files[0].name = general.skillFile;
	update = true;
	document.getElementById('createClass').innerHTML = "Mettre à jour une Classe";
	document.getElementById('butt').innerHTML = "Mettre à jour";

  loadClasse(general);
}

function countDiff(s1, s2) {
	var diffCount = 0;
	var diff = s1.length - s2.length;
	var len = 0;
	var j = 0;
	if(diff >= 0)
	{
		len = s2.length;
		diffCount += diff;

		for(var i = 0; i < len; i++)
		{
			if(s1[j] != s2[i])
			{
				diff -= 1;
				if(diff <= -1)
				{
					j++;
					i--;
					diffCount++;
				}
				else {
					i--;
				}
			}
			else
				j++;
		}
	}
	else {
		len = s1.length;
		diff = -diff;
		diffCount += diff;

		console.log(diffCount);
		for(var i = 0; i < len; i++)
		{
			if(s1[i] != s2[j])
			{
				diff -= 1;
				if(diff <= -1)
				{
					j++;
					i--;
					diffCount++;
				}
				else {
					i--;
				}
			}
			else
				j++;
		}
	}
	console.log(diffCount);
	return diffCount;
}

function checkStudent() {
	var diff = classesG.eleve.length - general.eleve.length;

	for(var i = 0; i < general.eleve.length; i++)
	{
		var nom = false;
		var prenom = false;

		if(general.eleve[i].eleve.name == classesG.eleve[i].name)
			nom = true;
		else
			if(countDiff(general.eleve[i].eleve.name, classesG.eleve[i].name) <= 3)
				nom = true;

		if(general.eleve[i].eleve.prenom == classesG.eleve[i].prenom)
			prenom = true;
		else
			if(countDiff(general.eleve[i].eleve.prenom, classesG.eleve[i].prenom) <= 3)
				prenom = true;

		if(nom && prenom)
		{
			general.eleve[i].eleve = classesG.eleve[i];
		}
		else// if (!nom && !prenom)
		{
			//new student
			if(diff >= 0)
			{
				console.log("add");

				var newStudent = {
					eleve:classesG.eleve[i],
					skillArray:general.skills
					};

				general.eleve.splice(i, 0, newStudent);
				diff = classesG.eleve.length - general.eleve.length;
				i=0;
			}
			//delete student
			else if(diff < 0)
			{
				console.log("del");
				console.log(general.eleve.splice(i, 1));
				diff = classesG.eleve.length - general.eleve.length;
				i=0;
			}
		}
		// else
		// {
		// 	console.log(nom);
		// 	console.log(prenom);
		// }
	}

	if(diff > 0)
	{
		for(var j =general.eleve.length; j < classesG.eleve.length; j++)
		{
			console.log("add");

			var newStudent = {
				eleve:classesG.eleve[j],
				skillArray:general.skills
				};

			general.eleve.splice(j, 0, newStudent);
		}
	}

	loadClasse(general);
}

function checkSkill() {


	var diff = skillsG.skill.length - general.skills.length;
	console.log(diff);
	for(var i = 0; i < general.skills.length; i++)
	{
		var nom = false;
		var matiere = false;

		if(general.skills[i].skill.name == skillsG.skill[i].name)
			nom = true;
		else
			if(countDiff(general.skills[i].skill.name, skillsG.skill[i].name) <= 3)
				nom = true;

		if(general.skills[i].skill.matiere == skillsG.skill[i].matiere)
			matiere = true;
		else
			if(countDiff(general.skills[i].skill.matiere, skillsG.skill[i].matiere) <= 3)
				matiere = true;

		if(nom && matiere)
		{
			general.skills[i].skill = skillsG.skill[i];
		}
		else// if (!nom && !prenom)
		{
			//new student
			if(diff >= 0)
			{
				console.log("add");

				var newSkill = {
					name:skillsG.skill[i].name,
					type:skillsG.skill[i].type,
					matiere:skillsG.skill[i].matiere,
					min:skillsG.skill[i].min,
					max:skillsG.skill[i].max,
					defaultVal:skillsG.skill[i].defaultVal,
					imgPath:skillsG.skill[i].imgPath
				};

				var newskillEleve = {
					skill:newSkill,
					value:"0",
					photoPath:["none"]
					};


				console.log(newSkill);
				general.skills.splice(i, 0, newskillEleve);
				diff = skillsG.skill.length - general.skills.length;
				i=0;
			}
			//delete student
			else if(diff < 0)
			{
				console.log("del");
				console.log(general.skills.splice(i, 1));
				diff = skillsG.skill.length - general.skills.length;
				i=0;
			}
		}
	}
	if(diff > 0)
	{
		for(var j =general.skills.length; j < skillsG.skill.length; j++)
		{
			var newSkill = {
				name:skillsG.skill[j].name,
				type:skillsG.skill[j].type,
				matiere:skillsG.skill[j].matiere,
				min:skillsG.skill[j].min,
				max:skillsG.skill[j].max,
				defaultVal:skillsG.skill[j].defaultVal,
				imgPath:skillsG.skill[j].imgPath
			};

			var newskillEleve = {
				skill:newSkill,
				value:"0",
				photoPath:["none"]
				};


			console.log(newSkill);
			general.skills.splice(j, 0, newskillEleve);
			diff = skillsG.skill.length - general.skills.length;
		}
	}
	dispatchToStudent();
}

function dispatchToStudent()
{
	var diff = general.skills.length - general.eleve[0].skillArray.length;
	for(var i = 0; i < general.eleve[0].skillArray.length; i++)
	{
		//check for the first student
		var name = false;
		var matière = false;

		if(general.skills[i].skill.name == general.eleve[0].skillArray[i].skill.name)
			name = true;
		else
			if(countDiff(general.skills[i].skill.name, general.eleve[0].skillArray[i].skill.name) <= 3)
				name = true;

		if(general.skills[i].skill.matiere == general.eleve[0].skillArray[i].skill.matiere)
			matiere = true;
		else
			if(countDiff(general.skills[i].skill.matiere, general.eleve[0].skillArray[i].skill.matiere) <= 3)
				matiere = true;

		if(name && matiere)
		{
			for(var j =0; j < general.eleve.length; j++)
			{
				general.eleve[j].skillArray[i].skill = general.skills[i].skill;
			}

		}
		else// if (!nom && !prenom)
		{
			//new student
			if(diff >= 0)
			{
				console.log("add");

				var newSkill = {
					name:general.skills[i].skill.name,
					type:general.skills[i].skill.type,
					matiere:general.skills[i].skill.matiere,
					min:general.skills[i].skill.min,
					max:general.skills[i].skill.max,
					defaultVal:general.skills[i].skill.defaultVal,
					imgPath:general.skills[i].skill.imgPath
				};

				var newskillEleve = {
					skill:newSkill,
					value:general.skills[i].skill.defaultVal.toString(),
					photoPath:["none"]
					};


				console.log(newSkill);
				for(var j =0; j < general.eleve.length; j++)
				{
					general.eleve[j].skillArray.splice(i, 0, newskillEleve);
				}
				diff = general.skills.length - general.eleve[0].skillArray.length;
				i=0;
			}
			//delete student
			else if(diff < 0)
			{
				console.log("del");
				for(var j =0; j < general.eleve.length; j++)
				{
					console.log(general.eleve[j].skillArray.splice(i, 1));
				}
				diff = general.skills.length - general.eleve[0].skillArray.length;
				i=0;
			}
		}
	}
	if(diff > 0)
	{
		for(var j =general.eleve[0].skillArray.length; j < general.skills.length; j++)
		{
			var newSkill = {
				name:general.skills[j].skill.name,
				type:general.skills[j].skill.type,
				matiere:general.skills[j].skill.matiere,
				min:general.skills[j].skill.min,
				max:general.skills[j].skill.max,
				defaultVal:general.skills[j].skill.defaultVal,
				imgPath:general.skills[j].skill.imgPath
			};

			var newskillEleve = {
				skill:newSkill,
				value:general.skills[j].skill.defaultVal.toString(),
				photoPath:["none"]
				};


			console.log(newSkill);
			for(var k =0; k < general.eleve.length; k++)
			{
				general.eleve[k].skillArray.splice(k, 0, newskillEleve);
			}
			diff = skillsG.skill.length - general.skills.length;
		}
	}
}

function displayContentsClasse(contents) {
  var element = document.getElementById('file-contentClasse');
  element.innerHTML = contents;
  classesG = JSON.parse(contents);
  eleveCount = classesG.eleve.length;
	if(update == false) {
		general.studentFile = "./Eleves/"+document.getElementById('file-inputClasse').files[0].name;
		document.getElementById('file-inputSkill').style = "";
		document.getElementById('skillText').style = "";
	}
	else{
		console.log("checkStudent");
		checkStudent();
	}
}

function displayContentsSkill(contents) {
  var element = document.getElementById('file-contentSkill');
  element.innerHTML = contents;
  skillsG = JSON.parse(contents);
  skillCount = skillsG.skill.length;
	if(update == false) {
		general.skillFile = "./Competences/"+document.getElementById('file-inputSkill').files[0].name;
	  for(var i = 0; i < skillCount; i++) {
	  	var skill = {
	  		skill:JSON.parse(JSON.stringify(skillsG.skill[i])),
	  		value:skillsG.skill[i].defaultVal,
	  		photoPath:["none"]
	  	};
	  	skillArray[i] = skill;
	  }
		general.skills = JSON.parse(JSON.stringify(skillArray));
	  for(var i = 0; i < eleveCount; i++) {
	  	var eleve = {
	  		eleve:JSON.parse(JSON.stringify(classesG.eleve[i])),
	  		skillArray:JSON.parse(JSON.stringify(skillArray))
	  	};
	  	general.eleve[i] = eleve;
  	}
  loadClasse(general);
	}
	else{
		console.log("checkSkill");
		checkSkill();
	}
}

document.getElementById('file-input')
  .addEventListener('change', readSingleFile, false);

document.getElementById('file-inputClasse')
  .addEventListener('change', readSingleFileClasse, false);

document.getElementById('file-inputSkill')
  .addEventListener('change', readSingleFileSkill, false);

var genSkill = {
	name:"Nom",
	type:"Type",
	min:"0",
	max:"40",
	defaultVal:"0",
	imgPath:"none"
	};

var genEleve = {
	name:"Nom",
	prenom:"Prénom",
	imgPath:"none"
	};

var skillEleve = {
	skill:genSkill,
	value:"0",
	fail:false,
	almost:false,
	succeed:false,
	photoPath:["none"]
	};

var genClasse = {
	eleve:genEleve,
	skillArray:[skillEleve]
	};

var skillArray = [skillEleve];

var skillsG = {classe:"Classe", skill:[genSkill]};
var classesG = {classe:"Classe", eleve:[genEleve]};

var general = {classe:"Classe", skills:[skillEleve], eleve:[genClasse]};

var update = false;
var skillCount = 1;
var eleveCount = 1;

function createClasse() {
	document.getElementById('butt').style = "display:none";
	document.getElementById('classeText').style = "";
	document.getElementById('file-inputClasse').style = "";
	if(update == true){
		document.getElementById('skillText').style = "";
		document.getElementById('file-inputSkill').style = "";
	}
}

function createSkill() {
	skillsG = {classe:"Classe", skill:[genSkill]};
	skillCount = 1;
	loadSkills(skillsG);
}

function loadClasse(skillArray) {

	var skillDiv = document.getElementById("skills");
	//skillArray is empty so we fill with default value and will create a new json
	var result ="";

	result += "<form >";
	result += "<input id=\"checkSize\" type=\"checkbox\" name=\"checkSize\" value=\"CheckSize\"";
	result += " checked ";
	result += "> Demander la taille des images avant impression <br></form>";

	result += "<div id='skill0' >"+ addTextInput("classe", "Classe" , skillArray.classe) +"</div>";
	result += "<table><tr>";
	var colCount = 0;
	for(var i = 0; i < general.eleve.length; i++)
	{
		result += "<td>";
		result += addEleve(i, skillArray.eleve[i].eleve.name, skillArray.eleve[i].eleve.prenom, skillArray.eleve[i].eleve.imgPath);
		result += "</td>";
		colCount++;
		if( colCount == 3){
			result += "</tr><tr>";
			colCount = 0;
		}
	}
	result += "</tr></table>";
	result += "<p class='links'>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;<a onclick='save()'>Sauvegarder</a></p>";
	skillDiv.innerHTML = result;
}

function loadEleve(skillArray, eleve, matiere) {

	var skillDiv = document.getElementById("skills");
	//skillArray is empty so we fill with default value and will create a new json
	var result ="";

	result = "<div id='skill0' >"+ addText(skillArray.eleve[eleve].eleve.prenom) + " "+ addText(skillArray.eleve[eleve].eleve.name) +"</br> <img src=\""+skillArray.eleve[eleve].eleve.imgPath+"\" width='75' height'75'/></br></br></br>";
	result += "<p class='links'><a onclick='loadClasse(general)'>Retour Classe</a>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;<a onclick='loadMatiere(general, "+eleve+")'>Retour Matière</a>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;<a onclick='save()'>Sauvegarder</a></p></br></br></br></br></br></div>";

	for(var i = 0; i < general.eleve[eleve].skillArray.length; i++)
	{
		if(general.eleve[eleve].skillArray[i].skill.matiere == matiere) {
			result += "<table><tr><td>";
			result += addSkill(i,eleve, matiere, skillArray.eleve[eleve].skillArray[i]);
			result += "</td></tr></table>";
		}
	}

	result += "<p class='links'><a onclick='loadClasse(general)'>Retour Classe</a>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;<a onclick='loadMatiere(general, "+eleve+")'>Retour Matière</a>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;<a onclick='save()'>Sauvegarder</a></p>";
	skillDiv.innerHTML = result;

}

function AddCheckBoxPrint(eleve, count, fail, almost, succeed)
{
	 var ret = "<form >";
	 ret += "<input id=\"fail_"+eleve+"_"+count+"\" type=\"checkbox\" name=\"fail\" value=\"fail\"";
	 if(fail)
	 	ret += " checked ";
	 ret += "> Ne réussit pas encore <br>";

	 ret += "<input id=\"almost_"+eleve+"_"+count+"\" type=\"checkbox\"  name=\"fail\" value=\"almost\"";
	 if(almost)
	 	ret += " checked ";
	 ret += "> Est en voie de réussite <br>";

	 ret += "<input id=\"succeed_"+eleve+"_"+count+"\" type=\"checkbox\" name=\"fail\" value=\"succeed\"";
	 if(succeed)
	 	ret += " checked ";
	 ret += "> Réussit souvent <br>";

	 ret += "</form>";
	 return ret;
}

	var w , h;
	w = h = 150;


var color = ["Red", "Blue", "Green", "Gold", "Olive", "Purple", "Pink", "Cyan", "Black", "Orange"];

function addSkillPrint(count,eleve, matiere, skill) {

	ret = "</br></br>";
	ret += "<table><tr>";
	//ret += "<td width='200'>";
	ret += "<i><u>" + addText(skill.skill.name)+"</u>";
	if(skill.skill.type != "Type")
		ret += addText(skill.skill.type);
	ret += "</i><br></tr><tr>";
	ret += addNoClickableImgPrint(count, "img"+count, skill.skill.imgPath, w, h);

	var photoCount = 0;
	var boxes = false;
	for(var i = 0; i < skill.photoPath.length; i++) {
		if(photoCount == 3)
		{
			if(boxes == false && skill.photoPath.length > 3)
			{
				ret += "</tr><tr><td>" + AddCheckBoxPrint(eleve, count, skill.fail, skill.almost, skill.succeed) + "</td>";
				boxes = true;
			}
			else
				ret += "</tr><tr><td><text><text></td>";
			photoCount = 0;
		}
		if( skill.photoPath[i] != "none")
			ret += addNoClickableImgPrint(count, "photo"+i+count, skill.photoPath[i], w, h);
		photoCount++;
	}

	ret += "</tr><td>";
	// ret += addText("Valeur :");
	// ret += addText(skill.value);
	if(boxes == false)
		ret += AddCheckBoxPrint(eleve, count, skill.fail, skill.almost, skill.succeed);
	// //ret += "</td><td>";
	// ret += "<button align='right' id='minusButton"+count+"' data-skill="+count+" data-matiere=\""+matiere+"\" onclick='minus("+eleve+", this.dataset.skill, this.dataset.matiere)'> - </button><button  align='right' id='plusButton"+count+"' data-skill="+count+" data-matiere=\""+matiere+"\"  onclick='plus("+eleve+", this.dataset.skill, this.dataset.matiere)'> + </button>";

	ret += "</tr>";



	ret += "</table>"
	return ret;
}



function loadPrint(skillArray, eleve) {
	if(document.getElementById('checkSize').checked == true)
	{
		var size = prompt("Entrez une taille pour les images (150 par defaut) :", "150");
		if (size != null) {
				w = h = parseInt(size);
		}
	}

	//skillArray is empty so we fill with default value and will create a new json
	var result ="";
	var cam = [];
	var valueSucceed = 2, valueAlmost = 1, valueFail = 0;
	var matiere = [];
	var matInside = false;
	for(var i = 0; i < general.eleve[eleve].skillArray.length; i++)
	{
		for(var j = 0; j < matiere.length; j++) {
			if(matiere[j] == general.eleve[eleve].skillArray[i].skill.matiere) {
				matInside = true;
			}
		}

		if(!matInside) {
			matiere.push(general.eleve[eleve].skillArray[i].skill.matiere);
		}
		matInside = false;
	}



	result += "<div id='skill0' >"+ addText(skillArray.eleve[eleve].eleve.prenom) + " " + addText(skillArray.eleve[eleve].eleve.name) +"</br> <img src=\""+skillArray.eleve[eleve].eleve.imgPath+"\" width='75' height'75'/></br></br></br>";

	result += "<h2>Résumé</h2>";
	result += "<canvas id=\"camembert\" width=\"900\" height=\"400\"></canvas>";

	for(var j = 0; j < matiere.length; j++)
	{
		if(j != 0)
			result += "<p id='breakin'> </p>";
		result += "<h1 style=\"color:"+color[j]+"\">"+matiere[j] + "</h1></br>";
		for(var i = 0; i < general.eleve[eleve].skillArray.length; i++)
		{
			if(general.eleve[eleve].skillArray[i].skill.matiere == matiere[j])
			{
				result += "<table><tr><td>";
				result += addSkillPrint(i,eleve, matiere, skillArray.eleve[eleve].skillArray[i]);
				result += "</td></tr></table>";
			}
		}
	}

	for(var j = 0; j < matiere.length; j++)
	{
		if(cam[j] == undefined)
			cam.push(0);
		for(var i = 0; i < general.eleve[eleve].skillArray.length; i++)
		{
			if(matiere[j] == general.eleve[eleve].skillArray[i].skill.matiere)
			{
				if(general.eleve[eleve].skillArray[i].succeed)
				 	cam[j] += valueSucceed;
				if(general.eleve[eleve].skillArray[i].almost)
				 	cam[j] += valueAlmost;
				if(general.eleve[eleve].skillArray[i].fail)
					cam[j] += valueFail;
			}
		}
	}
	var max = 0;

	for(var j = 0; j < cam.length; j++)
		max += cam[j];

	for(var j = 0; j < cam.length; j++)
		cam[j] = cam[j]/max * 100;

	//graphe_camembert(cam, color, matiere);

	printThing(result, cam, color, matière);

}

function printThing(s, donnees, colors, legende)
{
  sessionStorage.setItem("sent", s);
	sessionStorage.setItem("donnes", s);
	sessionStorage.setItem("colors", s);
	sessionStorage.setItem("sent", s);

	var w = window.open("./printPage.html");
}

function loadMatiere(skillArray, eleve) {

	var skillDiv = document.getElementById("skills");
	//skillArray is empty so we fill with default value and will create a new json
	//skillDiv.innerHTML = "<div id='skill0' >"+ addText(skillArray.eleve[eleve].eleve.prenom) + " "+ skillArray.eleve[eleve].eleve.name +"</br> <img src'"+skillArray.eleve[eleve].eleve.imgPath+"' width='75' height'75'/></div>";
	var matiere = [];
	var cam = [];
	var valueSucceed = 2, valueAlmost = 1, valueFail = 0;
	var matInside = false;
	var result = "";
	result += "<h2>Résumé</h2>";
	result += "<canvas id=\"camembert\" width=\"900\" height=\"400\"></canvas>";
	for(var i = 0; i < general.eleve[eleve].skillArray.length; i++)
	{
		for(var j = 0; j < matiere.length; j++) {
			if(matiere[j] == general.eleve[eleve].skillArray[i].skill.matiere) {
				matInside = true;
			}
		}

		if(!matInside) {
			matiere.push(general.eleve[eleve].skillArray[i].skill.matiere);
			result += "<table><tr><td>";
			result += "<button id='buttMatiere"+i+"' data-eleve=\""+matiere[matiere.length-1]+"\" onclick='loadEleve(general, "+eleve+", this.dataset.eleve);'>"+matiere[matiere.length-1]+"</button>";
			result += "</td></tr></table>";
		}
		matInside = false;
	}
	result += "</br><p class='links'><a onclick='loadClasse(general)''>Retour Classe</a>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;<a onclick='save()'>Sauvegarder</a></p>";
	skillDiv.innerHTML = result;

	for(var j = 0; j < matiere.length; j++)
	{
		if(cam[j] == undefined)
			cam.push(0);
		for(var i = 0; i < general.eleve[eleve].skillArray.length; i++)
		{
			if(matiere[j] == general.eleve[eleve].skillArray[i].skill.matiere)
			{
				if(general.eleve[eleve].skillArray[i].succeed)
				 	cam[j] += valueSucceed;
				if(general.eleve[eleve].skillArray[i].almost)
				 	cam[j] += valueAlmost;
				if(general.eleve[eleve].skillArray[i].fail)
					cam[j] += valueFail;
			}
		}
	}
	var max = 0;

	for(var j = 0; j < cam.length; j++)
		max += cam[j];

	for(var j = 0; j < cam.length; j++)
		cam[j] = cam[j]/max * 100;

	graphe_camembert(cam, color, matiere);
	//console.log(cam);
}

function graphe_camembert(donnees, stylecolors, legendes) {

	var canvas = document.getElementById('camembert');
	var context = canvas.getContext('2d');

	// donnees en pourcentage
	//var donnees = [1,4,11,21,37,26];

	var diametre = Math.min(canvas.height, canvas.width) - 100;
	var rayon = diametre / 2;

	// position du centre du camembert
	var position_x = rayon + 20;
	var position_y = canvas.height / 2 + 20;

	var nb_donnees = donnees.length;
	var angle_initial = 0;
	//var stylecolors = ['fuchsia', 'orange', 'tan', 'rgb(0,0,255)', 'rgb(0,255,0)', 'rgb(255,0,0)'];

	var largeur_rect = 15;
	//var legendes = ['10 minutes','30 minutes','50 minutes','60 minutes','90 minutes','120 minutes'];

	for(var i=0;i<nb_donnees; i++) {
		var angles_degre = (donnees[i] / 100) * 360;// conversion pourcentage -> angle en degré
		DessinerAngle(context,position_x,position_y,rayon,angle_initial,angles_degre,stylecolors[i]);
		angle_initial += angles_degre;

		DessinerRectangle(
			context,
			diametre + 30,
			(largeur_rect + 3) * (i + 1),
			largeur_rect,largeur_rect,
			stylecolors[i]
		);
		context.font = '9pt Tahoma';//legendes
		context.fillStyle = '#000';//legendes
		context.fillText(legendes[i] ,diametre + 55,18 * i+30);//legendes
	}
	//context.fillText('La semaine',diametre+50,150);
}
// petit rectangle pour la légende
function DessinerRectangle(context,x0,y0,xl,yl,coloration) {
	context.beginPath();
	context.fillStyle = coloration;
	context.fillRect(x0,y0,xl,yl);
	context.closePath();
	context.fill();
}
function DessinerAngle(context,position_x,position_y,rayon,angle_initial,angles_degre,couleurs) {
	context.beginPath();
	context.fillStyle  = couleurs;
	var angle_initial_radian = angle_initial / (180 / Math.PI);// conversion angle en degré -> angle en radian
	var angles_radian = angles_degre / (180 / Math.PI);// conversion angle en degré -> angle en radian
	context.arc(position_x,position_y,rayon,angle_initial_radian,angle_initial_radian + angles_radian,0);
	context.lineTo(position_x, position_y);
	context.closePath();
	context.fill();
}

function addCount() {

		skillsG.classe = document.getElementById("classe").value;
	//skillsG.skill = [];
	for(var i = 0; i < skillCount; i++)
	{
		var sk = {
		name:document.getElementById("nom"+i).value,
		type:document.getElementById("type"+i).value,
		min:document.getElementById("min"+i).value,
		max:document.getElementById("max"+i).value,
		defaultVal:document.getElementById("defaultVal"+i).value,
		imgPath:document.getElementById("img"+i).src
		};
		skillsG.skill[i] = sk;
	}
	skillsG.skill.push(genSkill);
	skillCount++;
	loadSkills(skillsG);
}

function save() {
	if(document.getElementById("classe") != null)
		general.classe = document.getElementById("classe").value;
	var data = JSON.stringify(general);
	var url = "data:application/octet-stream,"+ encodeURIComponent(data);
	//var newWindow = window.open(url, 'neuesDokument');
	var link = document.createElement('a');
    link.download = general.classe+"Classe.json";
    link.href = url;
    link.click();
}

function addEleve(count, name, prenom, img) {
	ret = "<table onclick='loadMatiere(general, "+count+")' style='box-shadow: 0px 2px 10px #8e8e8e; padding: 15px;'><tr>";
	ret += "</tr><td>";
	ret += addText(prenom);
	ret += addText(name);
	ret += "</td></tr>";
	ret += addClickableImg(count, "img"+count, img);
	ret += "</tr>";
	ret += "</table>"
	ret += "<p class='links'><a onclick='loadPrint(general, "+count+")'>Imprimer</a></p>";
	return ret;
}

function addSkill(count,eleve, matiere, skill) {
	ret = "<table style='box-shadow: 0px 2px 10px #8e8e8e; padding: 15px;'><tr>";
	//ret += "<td width='200'>";
	ret += addText(skill.skill.name);
	ret += addText(skill.skill.type);
	ret += "</tr><tr>";
	ret += addNoClickableImg(count, "img"+count, skill.skill.imgPath);

	var photoCount = 0;
	for(var i = 0; i < skill.photoPath.length; i++) {
		if(photoCount == 3)
		{
			ret += "</tr><tr><td><text><text></td>"
			photoCount = 0;
		}
		ret += addImg(matiere, "photo"+i+count, i, "", skill.photoPath[i], eleve, count);
		photoCount++;
	}

	ret += "</tr><td>";
	ret += addText("Valeur :");
	ret += addText(skill.value);
	//ret += "</td><td>";
	ret += "<button align='right' id='minusButton"+count+"' data-skill="+count+" data-matiere=\""+matiere+"\" onclick='minus("+eleve+", this.dataset.skill, this.dataset.matiere)'> - </button><button  align='right' id='plusButton"+count+"' data-skill="+count+" data-matiere=\""+matiere+"\"  onclick='plus("+eleve+", this.dataset.skill, this.dataset.matiere)'> + </button>";
	ret += AddCheckBox(eleve, count, matiere, skill.fail, skill.almost, skill.succeed);
	ret += "</tr>";



	ret += "</table>"
	return ret;
}

function AddCheckBox(eleve, count, matiere, fail, almost, succeed)
{
	 var ret = "<form >";
	 ret += "<input id=\"fail_"+eleve+"_"+count+"\" type=\"checkbox\" data-matiere=\""+matiere+"\" name=\"fail\" onclick=\"succeedBox("+eleve+", "+count+", this)\" value=\"fail\"";
	 if(fail)
	 	ret += " checked ";
	 ret += "> Ne réussit pas encore <br>";

	 ret += "<input id=\"almost_"+eleve+"_"+count+"\" type=\"checkbox\" data-matiere=\""+matiere+"\" name=\"fail\" onclick=\"succeedBox("+eleve+", "+count+", this)\" value=\"almost\"";
	 if(almost)
	 	ret += " checked ";
	 ret += "> Est en voie de réussite <br>";

	 ret += "<input id=\"succeed_"+eleve+"_"+count+"\" type=\"checkbox\" data-matiere=\""+matiere+"\" name=\"fail\" onclick=\"succeedBox("+eleve+", "+count+", this)\" value=\"succeed\"";
	 if(succeed)
	 	ret += " checked ";
	 ret += "> Réussit souvent <br>";

	 ret += "</form>";
	 return ret;
}

function succeedBox(eleve, count, input)
{
	if(input.value == "fail")
		general.eleve[eleve].skillArray[count].fail = input.checked;

	if(input.value == "almost")
		general.eleve[eleve].skillArray[count].almost = input.checked;

	if(input.value == "succeed")
		general.eleve[eleve].skillArray[count].succeed = input.checked;

	loadEleve(general, eleve, input.dataset.matiere);
}

function minus(eleve, sCount, matiere) {
	var nb = parseInt(general.eleve[eleve].skillArray[sCount].value);
	nb--;
	var min = parseInt(general.eleve[eleve].skillArray[sCount].skill.min);
	if (nb < min)
		nb = min;
	general.eleve[eleve].skillArray[sCount].value = nb.toString();
	loadEleve(general, eleve, matiere);
}

function plus(eleve, sCount, matiere) {
	var nb = parseInt(general.eleve[eleve].skillArray[sCount].value);
	nb++;
	var max = parseInt(general.eleve[eleve].skillArray[sCount].skill.max);
	if (nb > max)
		nb = max;
	general.eleve[eleve].skillArray[sCount].value = nb.toString();
	loadEleve(general, eleve, matiere);
}

function addNoClickableImgPrint(count, id, path, w, h)
{
	var ret = "<td><img id='"+id+"' width='"+w+"' height='"+h+"' src=\""+path+"\"/></td>";

	return ret;
}

function addNoClickableImg(count, id, path)
{
	var ret = "<td><img id='"+id+"' width='200' height='200' src=\""+path+"\"/></td>";

	return ret;
}

function addClickableImg(count, id, path)
{
	var ret = "<td><img id='"+id+"' width='250' height='250' src=\""+path+"\"/></td>";

	return ret;
}

function addText(title) {
	var ret = "<text>"+title+" </text>";

	return ret;
}

function addTextInput(id, title, content) {
	var ret = "<td><text>"+title+"</text></td> <td><input id='"+id+"' value=\""+content+"\"/></td>";

	return ret;
}

function addImg(matiere, id, num, title, content, eleve, skill) {

	var ret = "<td width='210' id='td"+id+"'>";
	if (content == undefined || content == "none")
	{
		ret += "<input type='file' data-matiere=\""+matiere+"\" data-num="+num+" data-id=\""+id+"\" data-eleve="+eleve+" data-skill="+skill+" onchange='readURL(this, this.dataset.matiere, this.dataset.num, this.dataset.id, this.dataset.eleve, this.dataset.skill);' /></td>";
	}
	else
	{
		ret += "<img id='"+id+"' width='200' height='200' src=\""+content+"\" data-matiere=\""+matiere+"\" onclick='resetIMG ("+eleve+", "+skill+", this.dataset.matiere, "+num+")'/></td>";
	}

	return ret;
}

function readURL(input, matiere, num, id, eleve, skill) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();

		general.eleve[eleve].skillArray[skill].photoPath[num] = "./photo/"+input.files[0].name;
        reader.onload = function (e) {
            document.getElementById("td"+id).innerHTML = "<img id='photo"+id+"' width='200' height='200' src=\"./photo/"+input.files[0].name+"\" data-matiere=\""+matiere+"\" onclick='resetIMG ("+eleve+", "+skill+", this.dataset.matiere, "+num+")'/></td>";
						var none = false;
						for(var i = 0; i < general.eleve[eleve].skillArray[skill].photoPath.length; i++)
						{
							if (general.eleve[eleve].skillArray[skill].photoPath[i] == "none")
							{
								none = true;
							}
						}
						if(!none)
							general.eleve[eleve].skillArray[skill].photoPath.push("none");
						loadEleve(general, eleve, matiere);
        	//general.eleve[eleve].skillArray[skill].photoPath = document.getElementById("photo"+id).src;
        };

        reader.readAsDataURL(input.files[0]);
    }
}

function resetIMG (eleve, skill, matiere, num) {
	general.eleve[eleve].skillArray[skill].photoPath[num] = "none";
	loadEleve(general, eleve, matiere);
}

function lolilou(){
	document.getElementById("butt").innerHTML = skills[0][0];
	document.getElementById("butt").style = "display:none";
}
</script>
</body>
</html>
